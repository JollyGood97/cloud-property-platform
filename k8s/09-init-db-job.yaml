apiVersion: batch/v1
kind: Job
metadata:
  name: init-databases
  namespace: plot-listing
spec:
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.35
        command: ['sh', '-c', 'until nc -z postgres-service 5432; do echo waiting for postgres; sleep 2; done;']
      containers:
      - name: create-databases
        image: postgres:14-alpine
        env:
        - name: PGHOST
          value: postgres-service
        - name: PGDATABASE
          value: postgres  # Connect to default postgres database
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_USER
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        command:
        - sh
        - -c
        - |
          echo "Creating databases..."
          psql -d postgres -c "SELECT 1 FROM pg_database WHERE datname = 'listings_db'" | grep -q 1 || psql -d postgres -c "CREATE DATABASE listings_db;"
          psql -d postgres -c "SELECT 1 FROM pg_database WHERE datname = 'inquiries_db'" | grep -q 1 || psql -d postgres -c "CREATE DATABASE inquiries_db;"
          echo "Databases created successfully!"
          echo "Verifying databases..."
          psql -d postgres -c "\l" | grep -E "listings_db|inquiries_db"
